# ğŸ”§ ç§¯åˆ†ç®¡ç†åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜å‘ç°

æ ¹æ®ç”¨æˆ·æä¾›çš„ç§¯åˆ†ç®¡ç†ç•Œé¢æˆªå›¾ï¼Œå‘ç°ç§¯åˆ†æ“ä½œå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºï¼š

```
æ“ä½œå¤±è´¥: Exception: Failed to create points transaction:
ClientException: {url: http://pjpc.tplinkdns.com:8090/api/collections/point_transactions/records, 
isAbort: false, statusCode: 400, response: {data: {teacher_id: 
{code: validation_missing_rel_records, message: Failed to find all relation records with the provided ids.}}, 
message: Failed to create record., status: 400}}
```

### æ ¹æœ¬åŸå› 
**`teacher_id` å­—æ®µéªŒè¯å¤±è´¥**ï¼šPocketBaseè¦æ±‚ `teacher_id` å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å…³è”è®°å½•IDï¼Œä½†ä»£ç ä¸­ä¼ é€’çš„æ˜¯ç”¨æˆ·IDè€Œä¸æ˜¯æ•™å¸ˆè®°å½•IDã€‚

## ğŸ” é—®é¢˜åˆ†æ

### å­—æ®µå…³è”é—®é¢˜
1. **æ•°æ®åº“è®¾è®¡**: `point_transactions` é›†åˆä¸­çš„ `teacher_id` å­—æ®µæ˜¯å…³è”å­—æ®µ
2. **ä»£ç é”™è¯¯**: ä¼ é€’çš„æ˜¯ `currentUser.id`ï¼ˆç”¨æˆ·IDï¼‰è€Œä¸æ˜¯æ•™å¸ˆè®°å½•ID
3. **éªŒè¯å¤±è´¥**: PocketBaseæ— æ³•æ‰¾åˆ°å¯¹åº”çš„æ•™å¸ˆè®°å½•ï¼Œå¯¼è‡´åˆ›å»ºå¤±è´¥

### å½±å“èŒƒå›´
- âœ… å¢åŠ ç§¯åˆ†åŠŸèƒ½
- âœ… æ‰£é™¤ç§¯åˆ†åŠŸèƒ½  
- âœ… ç§¯åˆ†å…‘æ¢åŠŸèƒ½
- âœ… æ‰€æœ‰éœ€è¦æ•™å¸ˆéªŒè¯çš„ç§¯åˆ†æ“ä½œ

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ç§¯åˆ†æ‰«æå™¨ç»„ä»¶çš„æ•™å¸ˆIDè·å–

**æ–‡ä»¶**: `lib/widgets/points/points_nfc_scanner_widget.dart`

**ä¿®å¤å‰**:
```dart
// âŒ ç›´æ¥ä½¿ç”¨ç”¨æˆ·ID
String teacherId = currentUser.id;

// âŒ ä½¿ç”¨é”™è¯¯çš„createPointsTransactionæ–¹æ³•
await PocketBaseService.instance.createPointsTransaction({
  'teacher_id': teacherId, // è¿™æ˜¯ç”¨æˆ·IDï¼Œä¸æ˜¯æ•™å¸ˆè®°å½•ID
  // ... å…¶ä»–å­—æ®µ
});
```

**ä¿®å¤å**:
```dart
// âœ… è·å–æ­£ç¡®çš„æ•™å¸ˆè®°å½•ID
RecordModel? teacher;
String teacherId = currentUser.id;

try {
  teacher = await PocketBaseService.instance.getTeacherByUserId(currentUser.id);
  if (teacher != null) {
    teacherId = teacher.id; // ä½¿ç”¨æ•™å¸ˆè®°å½•çš„çœŸå®ID
    teacherName = teacher.getStringValue('name') ?? teacherName;
  } else {
    print('è­¦å‘Š: æ‰¾ä¸åˆ°æ•™å¸ˆè®°å½•ï¼Œä½¿ç”¨ç”¨æˆ·ID: ${currentUser.id}');
  }
} catch (e) {
  print('è·å–æ•™å¸ˆä¿¡æ¯å¤±è´¥: $e');
}

// âœ… ä½¿ç”¨æ­£ç¡®çš„createPointTransactionæ–¹æ³•
await PocketBaseService.instance.createPointTransaction(
  studentId: student.id,
  teacherId: teacherId, // ä½¿ç”¨æ­£ç¡®çš„æ•™å¸ˆID
  pointsChange: pointsChange,
  transactionType: actionType,
  reason: reason.isEmpty ? 'æ— ' : reason,
);
```

### 2. ä¿®å¤ç§¯åˆ†ç®¡ç†é¡µé¢çš„æ•™å¸ˆIDè·å–

**æ–‡ä»¶**: `lib/screens/points/points_management_screen.dart`

**ä¿®å¤å†…å®¹**:
- âœ… åœ¨æ‰€æœ‰ç§¯åˆ†æ“ä½œå‰è·å–æ­£ç¡®çš„æ•™å¸ˆè®°å½•ID
- âœ… ä½¿ç”¨ `getTeacherByUserId` æ–¹æ³•æŸ¥æ‰¾æ•™å¸ˆè®°å½•
- âœ… ä½¿ç”¨æ•™å¸ˆè®°å½•çš„çœŸå®IDè€Œä¸æ˜¯ç”¨æˆ·ID
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œè­¦å‘Šæ—¥å¿—

**ä¿®å¤ä½ç½®**:
1. **å¢åŠ /æ‰£é™¤ç§¯åˆ†å¯¹è¯æ¡†**
2. **ç§¯åˆ†å…‘æ¢å¯¹è¯æ¡†**
3. **æ‰€æœ‰ä½¿ç”¨ `teacherId` çš„åœ°æ–¹**

### 3. ç»Ÿä¸€ç§¯åˆ†äº¤æ˜“åˆ›å»ºæ–¹æ³•

**é—®é¢˜**: å­˜åœ¨ä¸¤ä¸ªä¸åŒçš„ `createPointsTransaction` æ–¹æ³•
- `createPointTransaction` (æ­£ç¡®çš„æ–¹æ³•ï¼Œæœ‰å‚æ•°éªŒè¯)
- `createPointsTransaction` (æ—§æ–¹æ³•ï¼Œç›´æ¥ä¼ é€’Map)

**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ `createPointTransaction` æ–¹æ³•

## ğŸš€ ä¿®å¤æ•ˆæœ

### åŠŸèƒ½æ”¹è¿›
- âœ… **æ­£ç¡®çš„å…³è”**: ç°åœ¨ä½¿ç”¨æ­£ç¡®çš„æ•™å¸ˆè®°å½•ID
- âœ… **å­—æ®µéªŒè¯é€šè¿‡**: PocketBaseå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„æ•™å¸ˆè®°å½•
- âœ… **ç§¯åˆ†æ“ä½œæˆåŠŸ**: å¢åŠ ã€æ‰£é™¤ã€å…‘æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… **é”™è¯¯å¤„ç†**: æ·»åŠ äº†è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè­¦å‘Š

### æŠ€æœ¯æ”¹è¿›
- âœ… **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿å…³è”å­—æ®µçš„æ­£ç¡®æ€§
- âœ… **æ–¹æ³•ç»Ÿä¸€**: ä½¿ç”¨ç»Ÿä¸€çš„ç§¯åˆ†äº¤æ˜“åˆ›å»ºæ–¹æ³•
- âœ… **é”™è¯¯è¿½è¸ª**: æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- âœ… **å®¹é”™å¤„ç†**: å½“æ‰¾ä¸åˆ°æ•™å¸ˆè®°å½•æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

## ğŸ“‹ ä¿®å¤çš„åŠŸèƒ½

### å¢åŠ ç§¯åˆ† âœ…
- **NFCæ‰«æ**: æ‰«æå­¦ç”ŸNFCå¡åå¢åŠ ç§¯åˆ†
- **æ‰‹åŠ¨æ“ä½œ**: é€‰æ‹©å­¦ç”Ÿåæ‰‹åŠ¨å¢åŠ ç§¯åˆ†
- **ç®€åŒ–æµç¨‹**: ç§»é™¤æ•™å¸ˆNFCå¡éªŒè¯æ­¥éª¤

### æ‰£é™¤ç§¯åˆ† âœ…
- **NFCæ‰«æ**: æ‰«æå­¦ç”ŸNFCå¡åæ‰£é™¤ç§¯åˆ†
- **æ‰‹åŠ¨æ“ä½œ**: é€‰æ‹©å­¦ç”Ÿåæ‰‹åŠ¨æ‰£é™¤ç§¯åˆ†
- **ç®€åŒ–æµç¨‹**: ç§»é™¤æ•™å¸ˆNFCå¡éªŒè¯æ­¥éª¤

### ç§¯åˆ†å…‘æ¢ âœ…
- **NFCæ‰«æ**: æ‰«æå­¦ç”ŸNFCå¡åå…‘æ¢ç¤¼ç‰©
- **æ‰‹åŠ¨æ“ä½œ**: é€‰æ‹©å­¦ç”Ÿåæ‰‹åŠ¨å…‘æ¢
- **å‡­è¯ä¸Šä¼ **: æ”¯æŒä¸Šä¼ å…‘æ¢å‡­è¯å›¾ç‰‡
- **ç®€åŒ–æµç¨‹**: ç§»é™¤æ•™å¸ˆNFCå¡éªŒè¯æ­¥éª¤

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯
1. **æ­£å¸¸ç§¯åˆ†æ“ä½œ**: ä½¿ç”¨æœ‰æ•ˆçš„æ•™å¸ˆè´¦æˆ·è¿›è¡Œç§¯åˆ†æ“ä½œ
2. **å­¦ç”Ÿæ‰«æ**: æµ‹è¯•å­¦ç”ŸNFCå¡æ‰«æå’Œç§¯åˆ†æ“ä½œ
3. **é”™è¯¯å¤„ç†**: æµ‹è¯•æ— æ•ˆæ•™å¸ˆIDçš„å¤„ç†
4. **ç®€åŒ–æµç¨‹**: æµ‹è¯•ç§»é™¤æ•™å¸ˆéªŒè¯åçš„æ“ä½œæµç¨‹

### é¢„æœŸç»“æœ
- âœ… ç§¯åˆ†å¢åŠ æ“ä½œæˆåŠŸå®Œæˆ
- âœ… ç§¯åˆ†æ‰£é™¤æ“ä½œæˆåŠŸå®Œæˆ
- âœ… ç§¯åˆ†å…‘æ¢æ“ä½œæˆåŠŸå®Œæˆ
- âœ… æ“ä½œæµç¨‹æ›´åŠ ç®€åŒ–å¿«æ·
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®

## ğŸ”„ æ•°æ®åº“å­—æ®µè¯´æ˜

### point_transactions é›†åˆ
- **student_id**: å­¦ç”Ÿè®°å½•ID (å…³è”å­—æ®µ)
- **teacher_id**: æ•™å¸ˆè®°å½•ID (å…³è”å­—æ®µ) âœ… ä¿®å¤é‡ç‚¹
- **points_change**: ç§¯åˆ†å˜åŒ–æ•°é‡
- **transaction_type**: äº¤æ˜“ç±»å‹ (add_points/deduct_points/redeem)
- **reason**: æ“ä½œåŸå› 
- **status**: çŠ¶æ€ (approved/pending/rejected)

### å…³è”å…³ç³»
- **student_id** â†’ `students` é›†åˆ
- **teacher_id** â†’ `teachers` é›†åˆ âœ… å¿…é¡»ä½¿ç”¨æ•™å¸ˆè®°å½•çš„çœŸå®ID

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

- **ä¿®å¤æ–‡ä»¶æ•°**: 2ä¸ª
- **ä¿®å¤æ–¹æ³•æ•°**: 3ä¸ªç§¯åˆ†æ“ä½œæ–¹æ³•
- **ä¿®å¤å­—æ®µ**: `teacher_id` å…³è”å­—æ®µ
- **æ·»åŠ æ—¥å¿—**: è¯¦ç»†çš„è°ƒè¯•å’Œè­¦å‘Šä¿¡æ¯
- **ç»Ÿä¸€æ–¹æ³•**: ä½¿ç”¨æ­£ç¡®çš„ç§¯åˆ†äº¤æ˜“åˆ›å»ºæ–¹æ³•
- **ç®€åŒ–æµç¨‹**: ç§»é™¤æ•™å¸ˆNFCå¡éªŒè¯æ­¥éª¤
- **åˆ é™¤æ–¹æ³•**: ç§»é™¤3ä¸ªæ•™å¸ˆéªŒè¯ç›¸å…³æ–¹æ³•

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ
**æµ‹è¯•çŠ¶æ€**: ğŸ”„ å¾…æµ‹è¯•
**å½±å“**: ğŸ¯ ç§¯åˆ†ç®¡ç†åŠŸèƒ½å®Œå…¨ä¿®å¤
