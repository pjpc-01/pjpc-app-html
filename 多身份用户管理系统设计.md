# 🔄 多身份用户管理系统设计

## 🎯 问题分析

### **当前状况**
- 用户只能拥有单一角色（admin、teacher、parent、accountant）
- 角色通过`role`字段存储，只能是一个值
- 权限检查基于单一角色

### **需求场景**
用户可能同时拥有多个身份：
- **教师 + 家长**：既是老师，也是某个学生的家长
- **管理员 + 教师**：既是管理员，也担任教学工作
- **管理员 + 家长**：既是管理员，也是家长
- **教师 + 管理员 + 家长**：三重身份

## 🏗️ 解决方案设计

### **方案一：多角色字段存储（推荐）**

#### **1. 数据库结构调整**
```sql
-- users 表结构调整
ALTER TABLE users ADD COLUMN roles TEXT DEFAULT '[]';  -- JSON数组存储多个角色
ALTER TABLE users ADD COLUMN active_role TEXT DEFAULT '';  -- 当前激活的角色
ALTER TABLE users ADD COLUMN role_switching_enabled BOOLEAN DEFAULT false;  -- 是否允许角色切换
```

#### **2. 角色数据结构**
```json
{
  "roles": ["admin", "teacher", "parent"],
  "active_role": "admin",
  "role_switching_enabled": true,
  "role_permissions": {
    "admin": {
      "can_manage_users": true,
      "can_view_all_data": true,
      "can_send_notifications": true
    },
    "teacher": {
      "can_view_assigned_classes": true,
      "can_mark_attendance": true,
      "can_manage_homework": true
    },
    "parent": {
      "can_view_child_data": true,
      "can_receive_notifications": true,
      "can_view_attendance": true
    }
  }
}
```

### **方案二：关系表存储**

#### **1. 创建用户角色关系表**
```sql
-- user_roles 表
CREATE TABLE user_roles (
  id TEXT PRIMARY KEY,
  user_id TEXT REFERENCES users(id),
  role TEXT NOT NULL,
  is_active BOOLEAN DEFAULT false,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 🔧 实现方案

### **1. AuthProvider 扩展**

```dart
class AuthProvider with ChangeNotifier {
  // 现有字段...
  List<String> _userRoles = [];
  String _activeRole = '';
  bool _roleSwitchingEnabled = false;
  
  // 获取所有角色
  List<String> get userRoles => _userRoles;
  
  // 获取当前激活角色
  String get activeRole => _activeRole;
  
  // 是否允许多角色切换
  bool get roleSwitchingEnabled => _roleSwitchingEnabled;
  
  // 检查是否有特定角色
  bool hasRole(String role) {
    return _userRoles.contains(role);
  }
  
  // 检查是否有多个角色
  bool get hasMultipleRoles => _userRoles.length > 1;
  
  // 切换角色
  Future<void> switchRole(String newRole) async {
    if (!_userRoles.contains(newRole)) {
      throw Exception('用户没有 $newRole 角色权限');
    }
    
    _activeRole = newRole;
    await _saveActiveRole(newRole);
    notifyListeners();
  }
  
  // 获取角色显示名称
  String getRoleDisplayName(String role) {
    switch (role) {
      case 'admin': return '管理员';
      case 'teacher': return '老师';
      case 'parent': return '家长';
      case 'accountant': return '会计';
      default: return '用户';
    }
  }
  
  // 获取所有角色的显示名称
  List<String> get roleDisplayNames {
    return _userRoles.map((role) => getRoleDisplayName(role)).toList();
  }
  
  // 兼容性方法（基于当前激活角色）
  bool get isAdmin => _activeRole == 'admin';
  bool get isTeacher => _activeRole == 'teacher';
  bool get isParent => _activeRole == 'parent';
  bool get isAccountant => _activeRole == 'accountant';
}
```

### **2. 角色切换UI组件**

```dart
class RoleSwitcherWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        if (!authProvider.hasMultipleRoles) {
          return SizedBox.shrink();
        }
        
        return Container(
          margin: EdgeInsets.all(AppSpacing.md),
          padding: EdgeInsets.all(AppSpacing.md),
          decoration: BoxDecoration(
            color: AppTheme.cardColor,
            borderRadius: BorderRadius.circular(AppRadius.md),
            border: Border.all(color: AppTheme.dividerColor),
            boxShadow: AppTheme.cardShadow,
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Icon(Icons.swap_horiz, color: AppTheme.primaryColor),
                  SizedBox(width: AppSpacing.sm),
                  Text(
                    '身份切换',
                    style: AppTextStyles.headline6,
                  ),
                ],
              ),
              SizedBox(height: AppSpacing.sm),
              Text(
                '当前身份: ${authProvider.getRoleDisplayName(authProvider.activeRole)}',
                style: AppTextStyles.bodyMedium,
              ),
              SizedBox(height: AppSpacing.sm),
              Wrap(
                spacing: AppSpacing.sm,
                children: authProvider.userRoles.map((role) {
                  final isActive = role == authProvider.activeRole;
                  return FilterChip(
                    label: Text(authProvider.getRoleDisplayName(role)),
                    selected: isActive,
                    onSelected: isActive ? null : (selected) {
                      authProvider.switchRole(role);
                    },
                    selectedColor: AppTheme.primaryColor.withOpacity(0.2),
                    checkmarkColor: AppTheme.primaryColor,
                  );
                }).toList(),
              ),
            ],
          ),
        );
      },
    );
  }
}
```

### **3. 权限管理扩展**

```dart
class PermissionManager {
  static bool canAccessFeature(String feature, AuthProvider authProvider) {
    final activeRole = authProvider.activeRole;
    
    switch (feature) {
      case 'student_management':
        return ['admin', 'teacher'].contains(activeRole);
      case 'teacher_management':
        return activeRole == 'admin';
      case 'attendance_management':
        return ['admin', 'teacher'].contains(activeRole);
      case 'points_management':
        return ['admin', 'teacher', 'parent'].contains(activeRole);
      case 'notification_management':
        return activeRole == 'admin';
      case 'view_child_data':
        return ['admin', 'parent'].contains(activeRole);
      case 'view_all_data':
        return activeRole == 'admin';
      default:
        return false;
    }
  }
  
  static List<String> getAccessibleFeatures(AuthProvider authProvider) {
    final activeRole = authProvider.activeRole;
    
    switch (activeRole) {
      case 'admin':
        return [
          'student_management',
          'teacher_management',
          'attendance_management',
          'points_management',
          'notification_management',
          'view_all_data',
          'system_settings'
        ];
      case 'teacher':
        return [
          'student_management',
          'attendance_management',
          'points_management',
          'view_assigned_classes'
        ];
      case 'parent':
        return [
          'points_management',
          'view_child_data',
          'receive_notifications'
        ];
      case 'accountant':
        return [
          'view_financial_data',
          'manage_payments'
        ];
      default:
        return [];
    }
  }
}
```

### **4. 首页动态布局**

```dart
class HomeScreen extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: CustomScrollView(
        slivers: [
          // 角色切换器
          SliverToBoxAdapter(
            child: RoleSwitcherWidget(),
          ),
          // 动态功能卡片
          SliverToBoxAdapter(
            child: _buildDynamicActionCards(context),
          ),
          // 其他内容...
        ],
      ),
    );
  }
  
  Widget _buildDynamicActionCards(BuildContext context) {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        final accessibleFeatures = PermissionManager.getAccessibleFeatures(authProvider);
        
        return GridView.count(
          crossAxisCount: 3,
          shrinkWrap: true,
          physics: NeverScrollableScrollPhysics(),
          childAspectRatio: 1.0,
          crossAxisSpacing: AppSpacing.md,
          mainAxisSpacing: AppSpacing.md,
          children: accessibleFeatures.map((feature) {
            return _buildActionCard(feature, authProvider);
          }).toList(),
        );
      },
    );
  }
}
```

## 📱 用户体验设计

### **1. 身份切换流程**

#### **登录后检测**
```dart
// 登录成功后检查用户角色
Future<void> _checkUserRoles() async {
  final userRoles = await _pocketBaseService.getUserRoles();
  
  if (userRoles.length > 1) {
    // 显示角色选择对话框
    _showRoleSelectionDialog(userRoles);
  } else {
    // 直接设置单一角色
    _setActiveRole(userRoles.first);
  }
}
```

#### **角色选择对话框**
```dart
void _showRoleSelectionDialog(List<String> roles) {
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: Text('选择身份'),
      content: Text('检测到您拥有多个身份，请选择要使用的身份：'),
      actions: roles.map((role) {
        return ElevatedButton(
          onPressed: () {
            authProvider.switchRole(role);
            Navigator.pop(context);
          },
          child: Text(authProvider.getRoleDisplayName(role)),
        );
      }).toList(),
    ),
  );
}
```

### **2. 界面适配**

#### **导航栏动态调整**
```dart
List<NavigationItem> get navigationItems {
  final activeRole = authProvider.activeRole;
  
  switch (activeRole) {
    case 'admin':
      return [
        NavigationItem(icon: Icons.home, label: '首页', route: '/home'),
        NavigationItem(icon: Icons.people, label: '学生', route: '/students'),
        NavigationItem(icon: Icons.school, label: '教师', route: '/teachers'),
        NavigationItem(icon: Icons.nfc, label: 'NFC', route: '/nfc'),
        NavigationItem(icon: Icons.person, label: '个人', route: '/profile'),
      ];
    case 'teacher':
      return [
        NavigationItem(icon: Icons.home, label: '首页', route: '/home'),
        NavigationItem(icon: Icons.access_time, label: '考勤', route: '/attendance'),
        NavigationItem(icon: Icons.people, label: '学生', route: '/students'),
        NavigationItem(icon: Icons.stars, label: '积分', route: '/points'),
        NavigationItem(icon: Icons.person, label: '个人', route: '/profile'),
      ];
    case 'parent':
      return [
        NavigationItem(icon: Icons.home, label: '首页', route: '/home'),
        NavigationItem(icon: Icons.stars, label: '积分', route: '/points'),
        NavigationItem(icon: Icons.person, label: '个人', route: '/profile'),
      ];
    default:
      return [];
  }
}
```

### **3. 数据过滤**

#### **学生数据过滤**
```dart
List<RecordModel> getFilteredStudentsByRole() {
  final activeRole = authProvider.activeRole;
  
  switch (activeRole) {
    case 'admin':
      return _students; // 管理员查看所有学生
    case 'teacher':
      return _getStudentsForTeacher(); // 老师查看分配班级的学生
    case 'parent':
      return _getStudentsForParent(); // 家长查看自己的孩子
    default:
      return [];
  }
}
```

## 🔒 安全考虑

### **1. 权限验证**
- 每次角色切换都需要重新验证权限
- 敏感操作需要额外确认
- 记录角色切换日志

### **2. 数据隔离**
- 不同角色看到的数据范围不同
- 防止越权访问
- 敏感信息保护

### **3. 审计日志**
```dart
class RoleSwitchLogger {
  static Future<void> logRoleSwitch(String fromRole, String toRole, String userId) async {
    await _pocketBaseService.createLog({
      'type': 'role_switch',
      'user_id': userId,
      'from_role': fromRole,
      'to_role': toRole,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }
}
```

## 📊 实施计划

### **第一阶段：基础架构**
1. 修改数据库结构
2. 扩展AuthProvider
3. 实现角色切换逻辑

### **第二阶段：UI实现**
1. 创建角色切换组件
2. 修改首页布局
3. 适配导航栏

### **第三阶段：权限管理**
1. 实现权限管理器
2. 修改数据过滤逻辑
3. 添加安全验证

### **第四阶段：测试优化**
1. 多角色用户测试
2. 权限边界测试
3. 用户体验优化

## 🎯 预期效果

### **用户体验**
- ✅ 无缝身份切换
- ✅ 个性化界面
- ✅ 权限清晰明确

### **管理效率**
- ✅ 减少账户数量
- ✅ 简化权限管理
- ✅ 提高数据一致性

### **系统安全**
- ✅ 权限隔离
- ✅ 操作审计
- ✅ 数据保护

这个多身份用户管理系统将大大提升用户体验，特别是对于那些同时拥有多个身份的用户，让他们可以在不同身份之间自由切换，享受相应的功能和权限。
