# ğŸ”„ å¤šèº«ä»½ç”¨æˆ·ç®¡ç†ç³»ç»Ÿè®¾è®¡

## ğŸ¯ é—®é¢˜åˆ†æ

### **å½“å‰çŠ¶å†µ**
- ç”¨æˆ·åªèƒ½æ‹¥æœ‰å•ä¸€è§’è‰²ï¼ˆadminã€teacherã€parentã€accountantï¼‰
- è§’è‰²é€šè¿‡`role`å­—æ®µå­˜å‚¨ï¼Œåªèƒ½æ˜¯ä¸€ä¸ªå€¼
- æƒé™æ£€æŸ¥åŸºäºå•ä¸€è§’è‰²

### **éœ€æ±‚åœºæ™¯**
ç”¨æˆ·å¯èƒ½åŒæ—¶æ‹¥æœ‰å¤šä¸ªèº«ä»½ï¼š
- **æ•™å¸ˆ + å®¶é•¿**ï¼šæ—¢æ˜¯è€å¸ˆï¼Œä¹Ÿæ˜¯æŸä¸ªå­¦ç”Ÿçš„å®¶é•¿
- **ç®¡ç†å‘˜ + æ•™å¸ˆ**ï¼šæ—¢æ˜¯ç®¡ç†å‘˜ï¼Œä¹Ÿæ‹…ä»»æ•™å­¦å·¥ä½œ
- **ç®¡ç†å‘˜ + å®¶é•¿**ï¼šæ—¢æ˜¯ç®¡ç†å‘˜ï¼Œä¹Ÿæ˜¯å®¶é•¿
- **æ•™å¸ˆ + ç®¡ç†å‘˜ + å®¶é•¿**ï¼šä¸‰é‡èº«ä»½

## ğŸ—ï¸ è§£å†³æ–¹æ¡ˆè®¾è®¡

### **æ–¹æ¡ˆä¸€ï¼šå¤šè§’è‰²å­—æ®µå­˜å‚¨ï¼ˆæ¨èï¼‰**

#### **1. æ•°æ®åº“ç»“æ„è°ƒæ•´**
```sql
-- users è¡¨ç»“æ„è°ƒæ•´
ALTER TABLE users ADD COLUMN roles TEXT DEFAULT '[]';  -- JSONæ•°ç»„å­˜å‚¨å¤šä¸ªè§’è‰²
ALTER TABLE users ADD COLUMN active_role TEXT DEFAULT '';  -- å½“å‰æ¿€æ´»çš„è§’è‰²
ALTER TABLE users ADD COLUMN role_switching_enabled BOOLEAN DEFAULT false;  -- æ˜¯å¦å…è®¸è§’è‰²åˆ‡æ¢
```

#### **2. è§’è‰²æ•°æ®ç»“æ„**
```json
{
  "roles": ["admin", "teacher", "parent"],
  "active_role": "admin",
  "role_switching_enabled": true,
  "role_permissions": {
    "admin": {
      "can_manage_users": true,
      "can_view_all_data": true,
      "can_send_notifications": true
    },
    "teacher": {
      "can_view_assigned_classes": true,
      "can_mark_attendance": true,
      "can_manage_homework": true
    },
    "parent": {
      "can_view_child_data": true,
      "can_receive_notifications": true,
      "can_view_attendance": true
    }
  }
}
```

### **æ–¹æ¡ˆäºŒï¼šå…³ç³»è¡¨å­˜å‚¨**

#### **1. åˆ›å»ºç”¨æˆ·è§’è‰²å…³ç³»è¡¨**
```sql
-- user_roles è¡¨
CREATE TABLE user_roles (
  id TEXT PRIMARY KEY,
  user_id TEXT REFERENCES users(id),
  role TEXT NOT NULL,
  is_active BOOLEAN DEFAULT false,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### **1. AuthProvider æ‰©å±•**

```dart
class AuthProvider with ChangeNotifier {
  // ç°æœ‰å­—æ®µ...
  List<String> _userRoles = [];
  String _activeRole = '';
  bool _roleSwitchingEnabled = false;
  
  // è·å–æ‰€æœ‰è§’è‰²
  List<String> get userRoles => _userRoles;
  
  // è·å–å½“å‰æ¿€æ´»è§’è‰²
  String get activeRole => _activeRole;
  
  // æ˜¯å¦å…è®¸å¤šè§’è‰²åˆ‡æ¢
  bool get roleSwitchingEnabled => _roleSwitchingEnabled;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šè§’è‰²
  bool hasRole(String role) {
    return _userRoles.contains(role);
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªè§’è‰²
  bool get hasMultipleRoles => _userRoles.length > 1;
  
  // åˆ‡æ¢è§’è‰²
  Future<void> switchRole(String newRole) async {
    if (!_userRoles.contains(newRole)) {
      throw Exception('ç”¨æˆ·æ²¡æœ‰ $newRole è§’è‰²æƒé™');
    }
    
    _activeRole = newRole;
    await _saveActiveRole(newRole);
    notifyListeners();
  }
  
  // è·å–è§’è‰²æ˜¾ç¤ºåç§°
  String getRoleDisplayName(String role) {
    switch (role) {
      case 'admin': return 'ç®¡ç†å‘˜';
      case 'teacher': return 'è€å¸ˆ';
      case 'parent': return 'å®¶é•¿';
      case 'accountant': return 'ä¼šè®¡';
      default: return 'ç”¨æˆ·';
    }
  }
  
  // è·å–æ‰€æœ‰è§’è‰²çš„æ˜¾ç¤ºåç§°
  List<String> get roleDisplayNames {
    return _userRoles.map((role) => getRoleDisplayName(role)).toList();
  }
  
  // å…¼å®¹æ€§æ–¹æ³•ï¼ˆåŸºäºå½“å‰æ¿€æ´»è§’è‰²ï¼‰
  bool get isAdmin => _activeRole == 'admin';
  bool get isTeacher => _activeRole == 'teacher';
  bool get isParent => _activeRole == 'parent';
  bool get isAccountant => _activeRole == 'accountant';
}
```

### **2. è§’è‰²åˆ‡æ¢UIç»„ä»¶**

```dart
class RoleSwitcherWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        if (!authProvider.hasMultipleRoles) {
          return SizedBox.shrink();
        }
        
        return Container(
          margin: EdgeInsets.all(AppSpacing.md),
          padding: EdgeInsets.all(AppSpacing.md),
          decoration: BoxDecoration(
            color: AppTheme.cardColor,
            borderRadius: BorderRadius.circular(AppRadius.md),
            border: Border.all(color: AppTheme.dividerColor),
            boxShadow: AppTheme.cardShadow,
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Icon(Icons.swap_horiz, color: AppTheme.primaryColor),
                  SizedBox(width: AppSpacing.sm),
                  Text(
                    'èº«ä»½åˆ‡æ¢',
                    style: AppTextStyles.headline6,
                  ),
                ],
              ),
              SizedBox(height: AppSpacing.sm),
              Text(
                'å½“å‰èº«ä»½: ${authProvider.getRoleDisplayName(authProvider.activeRole)}',
                style: AppTextStyles.bodyMedium,
              ),
              SizedBox(height: AppSpacing.sm),
              Wrap(
                spacing: AppSpacing.sm,
                children: authProvider.userRoles.map((role) {
                  final isActive = role == authProvider.activeRole;
                  return FilterChip(
                    label: Text(authProvider.getRoleDisplayName(role)),
                    selected: isActive,
                    onSelected: isActive ? null : (selected) {
                      authProvider.switchRole(role);
                    },
                    selectedColor: AppTheme.primaryColor.withOpacity(0.2),
                    checkmarkColor: AppTheme.primaryColor,
                  );
                }).toList(),
              ),
            ],
          ),
        );
      },
    );
  }
}
```

### **3. æƒé™ç®¡ç†æ‰©å±•**

```dart
class PermissionManager {
  static bool canAccessFeature(String feature, AuthProvider authProvider) {
    final activeRole = authProvider.activeRole;
    
    switch (feature) {
      case 'student_management':
        return ['admin', 'teacher'].contains(activeRole);
      case 'teacher_management':
        return activeRole == 'admin';
      case 'attendance_management':
        return ['admin', 'teacher'].contains(activeRole);
      case 'points_management':
        return ['admin', 'teacher', 'parent'].contains(activeRole);
      case 'notification_management':
        return activeRole == 'admin';
      case 'view_child_data':
        return ['admin', 'parent'].contains(activeRole);
      case 'view_all_data':
        return activeRole == 'admin';
      default:
        return false;
    }
  }
  
  static List<String> getAccessibleFeatures(AuthProvider authProvider) {
    final activeRole = authProvider.activeRole;
    
    switch (activeRole) {
      case 'admin':
        return [
          'student_management',
          'teacher_management',
          'attendance_management',
          'points_management',
          'notification_management',
          'view_all_data',
          'system_settings'
        ];
      case 'teacher':
        return [
          'student_management',
          'attendance_management',
          'points_management',
          'view_assigned_classes'
        ];
      case 'parent':
        return [
          'points_management',
          'view_child_data',
          'receive_notifications'
        ];
      case 'accountant':
        return [
          'view_financial_data',
          'manage_payments'
        ];
      default:
        return [];
    }
  }
}
```

### **4. é¦–é¡µåŠ¨æ€å¸ƒå±€**

```dart
class HomeScreen extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: CustomScrollView(
        slivers: [
          // è§’è‰²åˆ‡æ¢å™¨
          SliverToBoxAdapter(
            child: RoleSwitcherWidget(),
          ),
          // åŠ¨æ€åŠŸèƒ½å¡ç‰‡
          SliverToBoxAdapter(
            child: _buildDynamicActionCards(context),
          ),
          // å…¶ä»–å†…å®¹...
        ],
      ),
    );
  }
  
  Widget _buildDynamicActionCards(BuildContext context) {
    return Consumer<AuthProvider>(
      builder: (context, authProvider, child) {
        final accessibleFeatures = PermissionManager.getAccessibleFeatures(authProvider);
        
        return GridView.count(
          crossAxisCount: 3,
          shrinkWrap: true,
          physics: NeverScrollableScrollPhysics(),
          childAspectRatio: 1.0,
          crossAxisSpacing: AppSpacing.md,
          mainAxisSpacing: AppSpacing.md,
          children: accessibleFeatures.map((feature) {
            return _buildActionCard(feature, authProvider);
          }).toList(),
        );
      },
    );
  }
}
```

## ğŸ“± ç”¨æˆ·ä½“éªŒè®¾è®¡

### **1. èº«ä»½åˆ‡æ¢æµç¨‹**

#### **ç™»å½•åæ£€æµ‹**
```dart
// ç™»å½•æˆåŠŸåæ£€æŸ¥ç”¨æˆ·è§’è‰²
Future<void> _checkUserRoles() async {
  final userRoles = await _pocketBaseService.getUserRoles();
  
  if (userRoles.length > 1) {
    // æ˜¾ç¤ºè§’è‰²é€‰æ‹©å¯¹è¯æ¡†
    _showRoleSelectionDialog(userRoles);
  } else {
    // ç›´æ¥è®¾ç½®å•ä¸€è§’è‰²
    _setActiveRole(userRoles.first);
  }
}
```

#### **è§’è‰²é€‰æ‹©å¯¹è¯æ¡†**
```dart
void _showRoleSelectionDialog(List<String> roles) {
  showDialog(
    context: context,
    builder: (context) => AlertDialog(
      title: Text('é€‰æ‹©èº«ä»½'),
      content: Text('æ£€æµ‹åˆ°æ‚¨æ‹¥æœ‰å¤šä¸ªèº«ä»½ï¼Œè¯·é€‰æ‹©è¦ä½¿ç”¨çš„èº«ä»½ï¼š'),
      actions: roles.map((role) {
        return ElevatedButton(
          onPressed: () {
            authProvider.switchRole(role);
            Navigator.pop(context);
          },
          child: Text(authProvider.getRoleDisplayName(role)),
        );
      }).toList(),
    ),
  );
}
```

### **2. ç•Œé¢é€‚é…**

#### **å¯¼èˆªæ åŠ¨æ€è°ƒæ•´**
```dart
List<NavigationItem> get navigationItems {
  final activeRole = authProvider.activeRole;
  
  switch (activeRole) {
    case 'admin':
      return [
        NavigationItem(icon: Icons.home, label: 'é¦–é¡µ', route: '/home'),
        NavigationItem(icon: Icons.people, label: 'å­¦ç”Ÿ', route: '/students'),
        NavigationItem(icon: Icons.school, label: 'æ•™å¸ˆ', route: '/teachers'),
        NavigationItem(icon: Icons.nfc, label: 'NFC', route: '/nfc'),
        NavigationItem(icon: Icons.person, label: 'ä¸ªäºº', route: '/profile'),
      ];
    case 'teacher':
      return [
        NavigationItem(icon: Icons.home, label: 'é¦–é¡µ', route: '/home'),
        NavigationItem(icon: Icons.access_time, label: 'è€ƒå‹¤', route: '/attendance'),
        NavigationItem(icon: Icons.people, label: 'å­¦ç”Ÿ', route: '/students'),
        NavigationItem(icon: Icons.stars, label: 'ç§¯åˆ†', route: '/points'),
        NavigationItem(icon: Icons.person, label: 'ä¸ªäºº', route: '/profile'),
      ];
    case 'parent':
      return [
        NavigationItem(icon: Icons.home, label: 'é¦–é¡µ', route: '/home'),
        NavigationItem(icon: Icons.stars, label: 'ç§¯åˆ†', route: '/points'),
        NavigationItem(icon: Icons.person, label: 'ä¸ªäºº', route: '/profile'),
      ];
    default:
      return [];
  }
}
```

### **3. æ•°æ®è¿‡æ»¤**

#### **å­¦ç”Ÿæ•°æ®è¿‡æ»¤**
```dart
List<RecordModel> getFilteredStudentsByRole() {
  final activeRole = authProvider.activeRole;
  
  switch (activeRole) {
    case 'admin':
      return _students; // ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ
    case 'teacher':
      return _getStudentsForTeacher(); // è€å¸ˆæŸ¥çœ‹åˆ†é…ç­çº§çš„å­¦ç”Ÿ
    case 'parent':
      return _getStudentsForParent(); // å®¶é•¿æŸ¥çœ‹è‡ªå·±çš„å­©å­
    default:
      return [];
  }
}
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### **1. æƒé™éªŒè¯**
- æ¯æ¬¡è§’è‰²åˆ‡æ¢éƒ½éœ€è¦é‡æ–°éªŒè¯æƒé™
- æ•æ„Ÿæ“ä½œéœ€è¦é¢å¤–ç¡®è®¤
- è®°å½•è§’è‰²åˆ‡æ¢æ—¥å¿—

### **2. æ•°æ®éš”ç¦»**
- ä¸åŒè§’è‰²çœ‹åˆ°çš„æ•°æ®èŒƒå›´ä¸åŒ
- é˜²æ­¢è¶Šæƒè®¿é—®
- æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

### **3. å®¡è®¡æ—¥å¿—**
```dart
class RoleSwitchLogger {
  static Future<void> logRoleSwitch(String fromRole, String toRole, String userId) async {
    await _pocketBaseService.createLog({
      'type': 'role_switch',
      'user_id': userId,
      'from_role': fromRole,
      'to_role': toRole,
      'timestamp': DateTime.now().toIso8601String(),
    });
  }
}
```

## ğŸ“Š å®æ–½è®¡åˆ’

### **ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„**
1. ä¿®æ”¹æ•°æ®åº“ç»“æ„
2. æ‰©å±•AuthProvider
3. å®ç°è§’è‰²åˆ‡æ¢é€»è¾‘

### **ç¬¬äºŒé˜¶æ®µï¼šUIå®ç°**
1. åˆ›å»ºè§’è‰²åˆ‡æ¢ç»„ä»¶
2. ä¿®æ”¹é¦–é¡µå¸ƒå±€
3. é€‚é…å¯¼èˆªæ 

### **ç¬¬ä¸‰é˜¶æ®µï¼šæƒé™ç®¡ç†**
1. å®ç°æƒé™ç®¡ç†å™¨
2. ä¿®æ”¹æ•°æ®è¿‡æ»¤é€»è¾‘
3. æ·»åŠ å®‰å…¨éªŒè¯

### **ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•ä¼˜åŒ–**
1. å¤šè§’è‰²ç”¨æˆ·æµ‹è¯•
2. æƒé™è¾¹ç•Œæµ‹è¯•
3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

## ğŸ¯ é¢„æœŸæ•ˆæœ

### **ç”¨æˆ·ä½“éªŒ**
- âœ… æ— ç¼èº«ä»½åˆ‡æ¢
- âœ… ä¸ªæ€§åŒ–ç•Œé¢
- âœ… æƒé™æ¸…æ™°æ˜ç¡®

### **ç®¡ç†æ•ˆç‡**
- âœ… å‡å°‘è´¦æˆ·æ•°é‡
- âœ… ç®€åŒ–æƒé™ç®¡ç†
- âœ… æé«˜æ•°æ®ä¸€è‡´æ€§

### **ç³»ç»Ÿå®‰å…¨**
- âœ… æƒé™éš”ç¦»
- âœ… æ“ä½œå®¡è®¡
- âœ… æ•°æ®ä¿æŠ¤

è¿™ä¸ªå¤šèº«ä»½ç”¨æˆ·ç®¡ç†ç³»ç»Ÿå°†å¤§å¤§æå‡ç”¨æˆ·ä½“éªŒï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›åŒæ—¶æ‹¥æœ‰å¤šä¸ªèº«ä»½çš„ç”¨æˆ·ï¼Œè®©ä»–ä»¬å¯ä»¥åœ¨ä¸åŒèº«ä»½ä¹‹é—´è‡ªç”±åˆ‡æ¢ï¼Œäº«å—ç›¸åº”çš„åŠŸèƒ½å’Œæƒé™ã€‚
