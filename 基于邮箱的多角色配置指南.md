# 📧 基于邮箱的多角色用户配置

## 🎯 实现方式

### **✅ 不需要添加数据库字段**
- 使用现有的 `role` 字段
- 通过邮箱识别多角色用户
- 在代码中配置多角色映射
- **自动检查teachers集合中的邮箱**

## 🔧 配置方法

### **1. 在代码中配置多角色用户**

在 `lib/providers/auth_provider.dart` 的 `_getMultiRoleUsersConfig()` 方法中添加：

```dart
Map<String, List<String>> _getMultiRoleUsersConfig() {
  return {
    'munpoo5566@gmail.com': ['admin', 'teacher', 'parent'],
    'admin_teacher@example.com': ['admin', 'teacher'],
    'teacher_parent@example.com': ['teacher', 'parent'],
    'triple_role@example.com': ['admin', 'teacher', 'parent'],
    // 添加你的多角色用户邮箱
    'your_email@example.com': ['admin', 'teacher'],
  };
}
```

### **2. 自动检测teachers集合**

系统会自动检查：
- `users` 集合中的用户邮箱
- `teachers` 集合中的教师邮箱
- 如果两个集合都有相同邮箱，自动添加 `teacher` 角色

## 📋 角色检测逻辑

### **检测顺序**
1. **配置文件检查**：检查是否在 `_getMultiRoleUsersConfig()` 中配置
2. **teachers集合检查**：检查 `teachers` 集合中是否有相同邮箱
3. **单一角色**：从 `users.role` 字段获取

### **自动角色添加**
- 如果用户在 `teachers` 集合中有记录，自动添加 `teacher` 角色
- 如果用户原本是 `admin`，现在也会是 `admin + teacher`
- 如果用户原本是 `parent`，现在也会是 `parent + teacher`

## 📊 实际应用场景

### **场景1：管理员也是教师**
```dart
// users集合
{
  "email": "admin@school.com",
  "role": "admin"
}

// teachers集合
{
  "email": "admin@school.com",
  "name": "张老师"
}

// 结果：用户拥有 admin + teacher 双重身份
```

### **场景2：家长也是教师**
```dart
// users集合
{
  "email": "parent@example.com", 
  "role": "parent"
}

// teachers集合
{
  "email": "parent@example.com",
  "name": "李老师"
}

// 结果：用户拥有 parent + teacher 双重身份
```

### **场景3：三重身份用户**
```dart
// 配置文件中
'munpoo5566@gmail.com': ['admin', 'teacher', 'parent']

// teachers集合中也有记录
{
  "email": "munpoo5566@gmail.com",
  "name": "王老师"
}

// 结果：用户拥有 admin + teacher + parent 三重身份
```

## 🎨 用户体验

### **自动角色检测**
- 登录后系统自动检查所有相关集合
- 无需手动配置，自动识别多角色
- 动态更新角色列表

### **角色切换**
- 显示所有检测到的角色
- 可以在不同身份间自由切换
- 切换后界面立即更新

## 🔒 权限管理

### **角色权限**
- **admin**: 所有管理功能
- **teacher**: 教学相关功能 + teachers集合中的权限
- **parent**: 家长相关功能

### **数据访问**
- 不同角色看到不同的数据范围
- 权限严格按角色隔离
- 防止越权访问

## 🚀 优势

### **智能检测**
- 自动检测多个集合中的用户
- 无需手动配置每个用户
- 动态识别角色变化

### **灵活管理**
- 可以随时添加或移除多角色用户
- 不需要数据库操作
- 配置变更立即生效

### **向后兼容**
- 现有单一角色用户不受影响
- 保持原有功能不变
- 平滑升级体验

## ⚠️ 注意事项

### **邮箱一致性**
- `users` 和 `teachers` 集合中的邮箱必须完全一致
- 区分大小写
- 确保邮箱格式正确

### **角色名称**
- 角色名称必须与现有 `role` 字段值一致
- 支持的角色：`admin`, `teacher`, `parent`, `accountant`
- 角色名称区分大小写

### **性能考虑**
- 异步检查teachers集合，不影响登录速度
- 角色检测完成后才更新界面
- 避免重复检查

## 🔄 使用流程

1. **登录**：使用邮箱登录
2. **检测**：系统自动检测所有相关集合
3. **识别**：识别用户的所有角色
4. **显示**：显示角色切换器（如果多角色）
5. **切换**：点击其他角色进行切换
6. **更新**：界面功能立即更新

现在系统会自动检查 `users` 和 `teachers` 集合，智能识别多角色用户！
