# 🔧 角色识别问题诊断和修复

## 🚨 问题描述

用户使用教师和管理员账号登录都显示为"学生"，操作界面都是学生的界面。

## 🔍 问题分析

### **可能的原因**

#### **1. 角色字段问题**
- `users`集合中的`role`字段可能没有正确设置
- 所有用户的`role`字段都是`student`或空值

#### **2. 角色识别逻辑问题**
- `_activeRole`没有正确初始化
- 角色检查方法没有正确回退到`role`字段

#### **3. 多角色系统干扰**
- 多角色系统可能覆盖了单一角色识别
- `_getRolesByEmail`方法返回空列表

## 🔧 修复方案

### **方案1：检查数据库角色字段**

#### **检查users集合**
```sql
-- 检查用户角色字段
SELECT id, email, name, role FROM users WHERE email IN (
  'pjpcemerlang@gmail.com',
  'munpoo5566@gmail.com'
);
```

#### **更新角色字段**
```sql
-- 更新管理员角色
UPDATE users SET role = 'admin' WHERE email = 'pjpcemerlang@gmail.com';

-- 更新教师角色
UPDATE users SET role = 'teacher' WHERE email = 'munpoo5566@gmail.com';
```

### **方案2：修复代码逻辑**

#### **已修复的问题**
1. ✅ **角色检查回退逻辑**：如果`_activeRole`为空，回退到`role`字段
2. ✅ **调试信息**：添加详细的调试日志
3. ✅ **角色显示名称**：修复`roleDisplayName`方法

#### **调试信息**
现在代码会输出以下调试信息：
```
=== 角色初始化调试 ===
用户邮箱: xxx@example.com
用户角色字段: admin
识别到的角色列表: [admin]
当前激活角色: admin
是否允许多角色切换: false
=== 角色初始化完成 ===
```

### **方案3：临时修复**

#### **强制设置角色**
如果数据库角色字段有问题，可以在代码中临时修复：

```dart
// 在_getRolesByEmail方法中添加
if (email == 'pjpcemerlang@gmail.com') {
  return ['admin'];
}
if (email == 'munpoo5566@gmail.com') {
  return ['teacher'];
}
```

## 📋 诊断步骤

### **步骤1：检查控制台输出**
1. 重新登录应用
2. 查看控制台输出的调试信息
3. 确认角色识别过程

### **步骤2：检查数据库**
1. 登录PocketBase管理界面
2. 查看`users`集合
3. 确认`role`字段值

### **步骤3：测试角色检查**
1. 在应用中添加调试按钮
2. 输出当前用户的所有角色信息
3. 验证角色检查结果

## 🎯 预期结果

### **管理员登录**
- 角色显示：管理员
- 界面：管理员功能界面
- 导航：首页、学生、教师、NFC、个人

### **教师登录**
- 角色显示：老师
- 界面：教师功能界面
- 导航：首页、考勤、学生、积分、个人

### **学生登录**
- 角色显示：学生
- 界面：学生功能界面
- 导航：首页、积分、个人

## 🔄 测试流程

### **测试1：管理员登录**
1. 使用管理员邮箱登录
2. 检查角色显示是否为"管理员"
3. 检查界面是否为管理员界面
4. 检查导航栏是否为管理员导航

### **测试2：教师登录**
1. 使用教师邮箱登录
2. 检查角色显示是否为"老师"
3. 检查界面是否为教师界面
4. 检查导航栏是否为教师导航

### **测试3：学生登录**
1. 使用学生邮箱登录
2. 检查角色显示是否为"学生"
3. 检查界面是否为学生界面
4. 检查导航栏是否为学生导航

## ⚠️ 注意事项

### **数据库一致性**
- 确保`users`集合中的`role`字段正确设置
- 确保邮箱地址完全一致（区分大小写）

### **代码逻辑**
- 多角色系统不应该影响单一角色用户
- 角色检查应该有正确的回退机制

### **调试信息**
- 查看控制台输出的调试信息
- 根据调试信息定位问题

## 🚀 下一步

1. **运行应用**：查看调试输出
2. **检查数据库**：确认角色字段
3. **测试登录**：验证角色识别
4. **修复问题**：根据诊断结果修复

现在代码已经添加了详细的调试信息和回退逻辑，应该能够正确识别用户角色了！
