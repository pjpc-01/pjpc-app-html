# 📊 多身份用户数据库配置

## 🗄️ 使用的集合

### **主要集合：`users`**
- 这是用户认证和基本信息的主要集合
- 存储用户登录凭据和角色信息

## 📋 需要添加的字段

### **多角色支持字段**

#### **1. `roles` (Text)**
- **类型**：Text
- **描述**：存储用户拥有的所有角色，用逗号分隔
- **示例值**：
  - `"admin"` - 单一管理员角色
  - `"teacher,parent"` - 教师+家长双重角色
  - `"admin,teacher,parent"` - 三重角色
- **默认值**：空字符串
- **必填**：否

#### **2. `active_role` (Text)**
- **类型**：Text
- **描述**：当前激活的角色
- **示例值**：
  - `"admin"` - 当前使用管理员身份
  - `"teacher"` - 当前使用教师身份
  - `"parent"` - 当前使用家长身份
- **默认值**：空字符串
- **必填**：否

#### **3. `role_switching_enabled` (Bool)**
- **类型**：Bool
- **描述**：是否允许多角色切换
- **示例值**：
  - `true` - 允许多角色切换
  - `false` - 不允许角色切换
- **默认值**：`false`
- **必填**：否

## 🔧 数据库操作

### **添加字段的SQL命令**

```sql
-- 添加多角色支持字段
ALTER TABLE users ADD COLUMN roles TEXT DEFAULT '';
ALTER TABLE users ADD COLUMN active_role TEXT DEFAULT '';
ALTER TABLE users ADD COLUMN role_switching_enabled BOOLEAN DEFAULT false;
```

### **PocketBase管理界面操作**

1. **进入PocketBase管理界面**
2. **选择 `users` 集合**
3. **点击 "Schema" 标签**
4. **添加以下字段**：

#### **字段1：roles**
- **Name**: `roles`
- **Type**: `Text`
- **Default**: `""`
- **Required**: `false`

#### **字段2：active_role**
- **Name**: `active_role`
- **Type**: `Text`
- **Default**: `""`
- **Required**: `false`

#### **字段3：role_switching_enabled**
- **Name**: `role_switching_enabled`
- **Type**: `Bool`
- **Default**: `false`
- **Required**: `false`

## 📝 测试数据示例

### **单一角色用户（保持兼容）**
```json
{
  "id": "user1",
  "email": "admin@example.com",
  "role": "admin",
  "roles": "",
  "active_role": "",
  "role_switching_enabled": false
}
```

### **多角色用户示例**

#### **教师+家长**
```json
{
  "id": "user2",
  "email": "teacher_parent@example.com",
  "role": "teacher",
  "roles": "teacher,parent",
  "active_role": "teacher",
  "role_switching_enabled": true
}
```

#### **管理员+教师**
```json
{
  "id": "user3",
  "email": "admin_teacher@example.com",
  "role": "admin",
  "roles": "admin,teacher",
  "active_role": "admin",
  "role_switching_enabled": true
}
```

#### **三重身份**
```json
{
  "id": "user4",
  "email": "triple_role@example.com",
  "role": "admin",
  "roles": "admin,teacher,parent",
  "active_role": "admin",
  "role_switching_enabled": true
}
```

## 🔄 数据迁移

### **现有用户数据迁移**

对于现有的单一角色用户，系统会自动兼容：

1. **如果 `roles` 字段为空**：
   - 系统会读取 `role` 字段
   - 将 `role` 值设置为 `roles` 和 `active_role`
   - 保持原有功能不变

2. **如果 `roles` 字段有值**：
   - 系统会解析 `roles` 字段
   - 使用 `active_role` 作为当前角色
   - 启用多角色功能

### **迁移脚本示例**

```sql
-- 为现有用户设置默认值
UPDATE users SET 
  roles = CASE 
    WHEN roles = '' THEN role 
    ELSE roles 
  END,
  active_role = CASE 
    WHEN active_role = '' THEN role 
    ELSE active_role 
  END,
  role_switching_enabled = CASE 
    WHEN roles LIKE '%,%' THEN true 
    ELSE false 
  END
WHERE roles IS NOT NULL;
```

## 🎯 使用说明

### **创建多角色用户**

1. **在PocketBase管理界面创建新用户**
2. **设置 `roles` 字段**：`"admin,teacher"`
3. **设置 `active_role` 字段**：`"admin"`
4. **设置 `role_switching_enabled` 字段**：`true`

### **测试角色切换**

1. **使用多角色用户登录**
2. **检查是否显示角色切换器**
3. **点击其他角色进行切换**
4. **验证界面功能变化**

## ⚠️ 注意事项

### **字段命名**
- 使用小写字母和下划线
- 字段名必须与代码中的一致
- 不要修改现有字段名

### **数据类型**
- `roles` 必须是 Text 类型
- `active_role` 必须是 Text 类型
- `role_switching_enabled` 必须是 Bool 类型

### **默认值**
- 新字段必须有默认值
- 默认值要与代码逻辑一致
- 避免空值导致的错误

### **兼容性**
- 保持与现有 `role` 字段的兼容性
- 单一角色用户不受影响
- 多角色用户获得新功能

## 🚀 实施步骤

1. **备份现有数据**
2. **添加新字段到 `users` 集合**
3. **设置字段默认值**
4. **测试现有用户登录**
5. **创建测试用的多角色用户**
6. **验证角色切换功能**

现在你只需要在 `users` 集合中添加这3个字段就可以启用多身份用户功能了！
